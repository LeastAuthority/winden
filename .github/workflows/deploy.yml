---
name: Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy target environment"
        type: choice
        options:
          - stage
          - prod
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare environment
        run: |
          touch ./client/.env
          if [ "${{ inputs.environment }}" = "prod" ]; then
            echo "MAILBOX_URL=wss://mailbox.winden.app/v1" >> ./client/.env
            echo "RELAY_URL=wss://relay.winden.app/" >> ./client/.env
          else
            echo "MAILBOX_URL=wss://mailbox.stage.winden.app/v1" >> ./client/.env
            echo "RELAY_URL=wss://relay.stage.winden.app/" >> ./client/.env
          fi
          cat <<EOF >> ./client/.env
          SFTP_HOSTNAME=${{ secrets.SFTP_HOSTNAME }}
          SFTP_USERNAME=${{ secrets.SFTP_USERNAME }}
          SFTP_IDENTITY="${{ secrets.SFTP_IDENTITY }}"
          NODE_ENV=production
          ENVIRONMENT=${{ inputs.environment }}
          EOF
          touch ./client-e2e/.env

      - name: Prepare containers
        run: |
          docker compose build --build-arg uid="$(id -u)" --build-arg gid="$(id -g)"
          docker compose run client npm i

      - name: Deploy package
        run: docker compose run client npm run deploy

      - name: Stop containers
        run: docker compose down
